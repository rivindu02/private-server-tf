---
- name: Setup Application Server
  hosts: app_servers
  become: yes
  vars_files:
    - vars.yml

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: safe
      async: 300
      poll: 10

    - name: Install system packages
      apt:
        name: "{{ item }}"
        state: present
      with_items: "{{ system_packages }}"

    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Install Docker Compose standalone
      shell: |
        curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
        ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
      args:
        creates: /usr/local/bin/docker-compose

    - name: Verify Docker Compose installation
      command: docker-compose --version
      register: compose_version

    - name: Display Docker Compose version
      debug:
        var: compose_version.stdout

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes
        

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Reset ssh connection to apply docker group
      meta: reset_connection
        # This script or command adds the 'ubuntu' user to the 'docker' group.
        # 
        # Purpose:
        # - The 'docker' group allows users to execute Docker commands without requiring
        #   root privileges or using 'sudo'. By adding the 'ubuntu' user to this group,
        #   the user can manage Docker containers and images more conveniently.
        #
        # Security Note:
        # - Adding a user to the 'docker' group grants them root-equivalent permissions
        #   over the Docker daemon. This is because Docker commands can access the host
        #   system and perform privileged operations. Use this configuration cautiously
        #   and only for trusted users.
        #
        # Usage:
        # - Run this script or command as a user with sufficient privileges (e.g., root or sudo).

    - name: Create application directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        # The 'mode' attribute specifies the file permissions for the target file or directory.
        # It is represented in octal format (e.g., '0755'), where:
        mode: '0755' #  0-> regular file, 7->rwx(read write execute), 5->r-x, 5->r-x

    - name: Clone Git repository
      git:
        repo: "{{ git_repo }}"
        dest: "{{ app_directory }}"
        version: main
        force: yes
      become_user: ubuntu
      when: git_repo != ""

    - name: Create .env file
      copy:
        content: |
          MONGO_URI={{ mongo_uri }}
          PORT={{ app_port }}
        dest: "{{ app_directory }}/.env"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Check if docker-compose.yml exists
      stat:
        path: "{{ app_directory }}/docker-compose.yml"
      register: compose_file

    - name: Start Docker Compose services
      shell: |
        cd {{ app_directory }}
        docker-compose up -d
      become_user: ubuntu
      when: git_repo != "" and compose_file.stat.exists
      register: compose_up

    - name: Display Docker Compose startup output
      debug:
        var: compose_up
      when: compose_up is defined

    - name: Verify containers are running
      shell: |
        cd {{ app_directory }}
        docker-compose ps
      become_user: ubuntu
      register: docker_status
      when: git_repo != "" and compose_file.stat.exists

    - name: Display container status
      debug:
        var: docker_status.stdout
      when: git_repo != ""

    - name: Log setup completion
      lineinfile:
        path: "{{ setup_log_file }}"
        line: "Setup completed at {{ ansible_date_time.iso8601 }}"
        create: yes