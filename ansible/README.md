# Ansible Automation

Automated configuration management for application deployment using Ansible.

## Overview

This Ansible configuration automates the deployment and configuration of the School Management API on AWS EC2 instances. It handles system setup, Docker installation, and application deployment.

## Prerequisites

- Ansible installed (`ansible --version` should be ≥ 2.9)
- SSH key configured (referenced in `inventory.ini`)
- Terraform infrastructure already deployed

## Quick Start

### 1. Verify Inventory

After running `terraform apply`, check that `inventory.ini` was generated:

```bash
cat inventory.ini
```

Expected output:
```ini
[app_servers]
10.0.2.x ansible_user=ubuntu

[bastion]
<bastion-ip> ansible_user=ubuntu

[app_servers:vars]
ansible_ssh_common_args='-o ProxyJump=ubuntu@<bastion-ip>'
```

### 2. Run the Playbook

```bash
# From the ansible directory
ansible-playbook -i inventory.ini playbook.yml \
  -e 'git_repo=https://github.com/your-org/your-repo.git'
```

**Note:** Wait 2-3 minutes after Terraform completes before running Ansible to allow instances to fully initialize.

## Configuration Files

### `playbook.yml`
Main playbook that orchestrates all tasks:
- Updates system packages
- Installs Docker and Docker Compose
- Clones application repository
- Creates environment configuration
- Starts Docker containers
- Displays completion status

### `inventory.ini`
Auto-generated by Terraform containing:
- App server private IPs
- Bastion host public IP
- SSH proxy configuration for accessing private instances

### `vars.yml`
Application configuration variables:
- `git_repo` - Git repository URL (can be overridden via `-e` flag)
- `app_directory` - Application directory path (default: `/app`)
- `mongo_uri` - MongoDB connection string (default: `mongodb://mongo:27017/school_db`)
- `app_port` - Application port (default: `3000`)
- `system_packages` - List of packages to install

**Customize this file** to match your application's requirements.

## What the Playbook Does

1. **System Setup**
   - Updates apt cache
   - Installs system dependencies

2. **Docker Installation**
   - Installs Docker CE
   - Installs Docker Compose
   - Adds ubuntu user to docker group
   - Starts Docker service

3. **Application Deployment**
   - Clones Git repository to `/app`
   - Creates `.env` file with MongoDB and port configuration
   - Runs `docker-compose up -d`
   - Waits for containers to start

4. **Verification**
   - Displays running containers
   - Shows deployment completion message

## Advanced Usage

### Running Specific Tasks

```bash
# Only install Docker
ansible-playbook -i inventory.ini playbook.yml --tags "docker"

# Only deploy application
ansible-playbook -i inventory.ini playbook.yml --tags "deploy"
```

### Override Variables

```bash
ansible-playbook -i inventory.ini playbook.yml \
  -e 'git_repo=https://github.com/user/repo.git' \
  -e 'app_port=8080' \
  -e 'mongo_uri=mongodb://mongo:27017/mydb'
```

### Check Mode (Dry Run)

```bash
ansible-playbook -i inventory.ini playbook.yml --check
```

## Troubleshooting

### Connection Issues

**Problem:** Cannot connect to app server  
**Solution:** Verify bastion host is accessible and inventory has correct proxy jump configuration

```bash
# Test SSH to bastion
ssh -i ~/.ssh/your-key.pem ubuntu@<bastion-ip>

# Test SSH to app server via bastion
ssh -i ~/.ssh/your-key.pem -J ubuntu@<bastion-ip> ubuntu@<app-private-ip>
```

### Docker Permission Denied

**Problem:** Docker commands fail with permission denied  
**Solution:** Playbook adds user to docker group, but requires logout/login or use `newgrp docker`

### Git Clone Fails

**Problem:** Repository not accessible  
**Solution:** 
- Verify repository URL is correct and accessible
- For private repos, add SSH key or access token

### Container Not Starting

**Problem:** Docker Compose fails to start containers  
**Solution:**
```bash
# SSH to app server and check logs
cd /app
docker-compose logs
```

## Manual Verification

After playbook runs, verify deployment:

```bash
# SSH to app server (via bastion)
ssh -i ~/.ssh/your-key.pem -J ubuntu@<bastion-ip> ubuntu@<app-private-ip>

# Check Docker is running
sudo systemctl status docker

# Check containers
docker ps

# Check application logs
docker logs <container-name>

# Test application
curl http://localhost:3000
```

## File Structure

```
ansible/
├── README.md           # This file
├── playbook.yml        # Main Ansible playbook
├── vars.yml           # Variable definitions
├── inventory.ini      # Auto-generated by Terraform
└── inventory.template # Template for inventory (reference only)
```

## Environment Variables

The playbook creates a `.env` file with:

```env
MONGO_URI=mongodb://mongo:27017/school_db
PORT=3000
```

Modify `vars.yml` to change these values.

## SSH Configuration

Access uses SSH proxy jump through bastion:

```bash
# Configured automatically in inventory.ini
ansible_ssh_common_args='-o ProxyJump=ubuntu@<bastion-ip>'
```

This allows Ansible to reach private instances without direct internet access.

## Best Practices

- Always use `--check` mode first to preview changes
- Keep sensitive data in Ansible Vault (not implemented in this basic setup)
- Tag tasks for selective execution
- Version control your playbooks
- Test in dev environment before production

## Additional Commands

```bash
# Check inventory
ansible-inventory -i inventory.ini --list

# Ping all hosts
ansible all -i inventory.ini -m ping

# Run ad-hoc commands
ansible app_servers -i inventory.ini -m shell -a 'docker ps'

# Get facts
ansible app_servers -i inventory.ini -m setup
```

---

For infrastructure documentation, see [INFRASTRUCTURE.md](../INFRASTRUCTURE.md)
